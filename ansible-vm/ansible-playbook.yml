---
- name: Configure remote server - add user with SSH key
  hosts: all
  become: yes
  vars:
    # Configuration variables - set these values before running
    new_username: "your_username"  # Change to the username you want to add
    new_user_ssh_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB..."  # Paste your SSH public key here
    new_user_shell: "/bin/bash"
    new_user_groups: "sudo,docker"  # Groups to which the user will be added
    
  tasks:
    - name: Check if user already exists
      getent:
        database: passwd
        key: "{{ new_username }}"
      register: user_exists
      failed_when: false
      changed_when: false

    - name: Create user if it doesn't exist
      user:
        name: "{{ new_username }}"
        shell: "{{ new_user_shell }}"
        create_home: yes
        state: present
      when: user_exists.ansible_facts.getent_passwd[new_username] is not defined

    - name: Create .ssh directory for user if it doesn't exist
      file:
        path: "/home/{{ new_username }}/.ssh"
        state: directory
        owner: "{{ new_username }}"
        group: "{{ new_username }}"
        mode: '0700'

    - name: Add SSH public key to authorized_keys
      authorized_key:
        user: "{{ new_username }}"
        state: present
        key: "{{ new_user_ssh_key }}"
        exclusive: no  # Doesn't remove existing keys, only adds new one

    - name: Check if docker group exists
      command: getent group docker
      register: docker_group_check
      failed_when: false
      changed_when: false

    - name: Add user to sudo/wheel and docker groups (if docker exists)
      user:
        name: "{{ new_username }}"
        groups: "{{ new_user_groups }}"
        append: yes  # Adds to existing groups instead of replacing
      when: docker_group_check.rc == 0

    - name: Add user only to sudo/wheel group (if docker doesn't exist)
      user:
        name: "{{ new_username }}"
        groups: "sudo"
        append: yes  # Adds to existing groups instead of replacing
      when: docker_group_check.rc != 0

    - name: Display configuration completion message
      debug:
        msg: "User {{ new_username }} has been successfully configured with SSH key. Added to sudo group{% if docker_group_check.rc == 0 %} and docker{% endif %}."
